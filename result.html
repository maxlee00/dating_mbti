<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²°ê³¼</title>

  <link rel="stylesheet" href="style.css" />

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SFN9HYKG8Q"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SFN9HYKG8Q');
  </script>
</head>

<body>
  <main class="wrap result-page">

    <!-- ë¶„ì„ ì˜¤ë²„ë ˆì´ -->
    <div class="analyze-overlay" id="analyzeOverlay" aria-live="polite">
      <div class="analyze-box">
        <div class="spinner" id="spinner"></div>
        <div class="check" id="check" style="display:none;">âœ“</div>
        <div class="analyze-title" id="analyzeTitle">ë¶„ì„ ì¤‘â€¦</div>
        <div class="analyze-sub" id="analyzeSub">ê²°ê³¼ë¥¼ ê³„ì‚°í•˜ê³  ìˆì–´ìš”</div>
      </div>
    </div>

    <!-- ê²°ê³¼ ì¹´ë“œ -->
    <section class="card result-card" id="resultCard" style="display:none;">
      <div class="madeby">made with young_cha</div>

      <!-- ìƒë‹¨: ì´ë¯¸ì§€ + íƒ€ì´í‹€ -->
      <div class="hero">
        <div class="hero-img">
          <img id="typeImg" alt="" />
        </div>

        <div class="result-head">
          <div class="result-label">ë‹¹ì‹ ì˜ ì—°ì•  MBTI</div>
          <div class="result-type" id="typeMain"></div>
          <div class="result-sub">í•µì‹¬ í‚¤ì›Œë“œ</div>
        </div>
      </div>

      <!-- í•´ì‹œíƒœê·¸/ì„¤ëª… -->
      <div class="hashtags" id="hashtags"></div>
      <ul class="bullets" id="bullets"></ul>

      <!-- ê·¸ë˜í”„ -->
      <div class="graph">
        <div class="graph-title">ì„±í–¥ ê·¸ë˜í”„</div>
        <div id="mbtiBars"></div>
      </div>

      <!-- CTA -->
      <div id="ctaArea" class="ctaArea"></div>
      <div class="ctaHint" id="variantHint"></div>
    </section>
  </main>

  <script src="app.js"></script>
  <script>
    // app.jsì— initExperiment, getVariant, track, calcWeightedMbti ë“±ì´ ìˆë‹¤ê³  ê°€ì •
    initExperiment();

    // ê²°ê³¼ ë°ì´í„°
    const mbti = sessionStorage.getItem("hp_mbti_v1");
    const scoreRaw = sessionStorage.getItem("hp_score_v1");
    const score = scoreRaw ? JSON.parse(scoreRaw) : null;

    // ìœ í˜•ë³„ ì½˜í…ì¸ (í•„ìš”í•œ ë§Œí¼ ì¶”ê°€)
    const PROFILES = {
      INTJ: {
        img: "assets/types/intj.png",
        hashtags: ["#ë¹„ì „", "#ì‚¬ê³ ", "#ë…¼ìŸ", "#ê²½ìŸ", "#ì¸ì •"],
        bullets: [
          "ëƒ‰ì² í•œ íŒë‹¨ê³¼ ìì‹ ì˜ ì´ì„±ì„ ë¯¿ëŠ”ë‹¤",
          "ì°½ì˜ì ì´ë©° ì „ëµì ì¸ ì‚¬ê³ ê°€ ë¹ ë¥¸ í¸ì´ë‹¤",
          "ì–´ë–¤ ê²ƒì— ëŒ€í•´ ë¨¼ì € ì˜ì‹¬ë¶€í„° í•´ë³¸ë‹¤",
          "ê¶Œìœ„ë‚˜ ì§€ìœ„ì— ë³µì¢…í•˜ì§€ ì•ŠëŠ”ë‹¤",
          "ë¹„ì „ì„ ì„¸ìš°ê³  ê³„íší•˜ê¸° ì¢‹ì•„í•œë‹¤"
        ]
      },
      ENFP: {
        img: "assets/types/enfp.png",
        hashtags: ["#ì„¤ë ˜", "#ììœ ", "#ì¦‰í¥", "#ë¦¬ì•¡ì…˜", "#ê³µê°"],
        bullets: [
          "ìƒˆë¡œìš´ ìê·¹ê³¼ ì‚¬ëŒì—ê²Œì„œ ì—ë„ˆì§€ë¥¼ ì–»ëŠ”ë‹¤",
          "ê°ì • í‘œí˜„ì´ ì†”ì§í•˜ê³  ë¦¬ì•¡ì…˜ì´ í’ë¶€í•˜ë‹¤",
          "ê´€ê³„ì— â€˜ì¬ë¯¸â€™ì™€ â€˜ì˜ë¯¸â€™ë¥¼ ë™ì‹œì— ì›í•œë‹¤",
        ]
      }
    };

    function getProfile(type) {
      const fallback = {
        img: "assets/logo.png",
        hashtags: ["#ì—°ì• ", "#ì„±í–¥", "#MBTI"],
        bullets: ["ìœ í˜•ë³„ ì„¤ëª…ì„ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ™‚"]
      };
      return (type && PROFILES[type]) ? PROFILES[type] : fallback;
    }

    // DOM
    const overlay = document.getElementById('analyzeOverlay');
    const resultCard = document.getElementById('resultCard');
    const spinner = document.getElementById('spinner');
    const check = document.getElementById('check');
    const aTitle = document.getElementById('analyzeTitle');
    const aSub = document.getElementById('analyzeSub');

    const typeMain = document.getElementById('typeMain');
    const typeImg = document.getElementById('typeImg');
    const hashtagsEl = document.getElementById('hashtags');
    const bulletsEl = document.getElementById('bullets');
    const mbtiBarsEl = document.getElementById('mbtiBars');

    // ê²°ê³¼ ì—†ìŒ ì²˜ë¦¬
    if (!mbti) {
      overlay.style.display = 'none';
      resultCard.style.display = 'block';

      typeMain.textContent = "ê²°ê³¼ ì—†ìŒ";
      typeImg.style.display = "none";

      hashtagsEl.innerHTML = `<span class="tag">#ì—°ì• </span><span class="tag">#ì„±í–¥</span><span class="tag">#MBTI</span>`;
      bulletsEl.innerHTML = `<li>í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš” ğŸ™‚</li>`;
      mbtiBarsEl.innerHTML = `<div class="muted">ê·¸ë˜í”„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.</div>`;

      document.getElementById('ctaArea').innerHTML = `
        <a class="btn btn-primary" href="index.html">ì²˜ìŒìœ¼ë¡œ</a>
      `;
    } else {
      // ì½˜í…ì¸  ì„¸íŒ…
      const profile = getProfile(mbti);

      typeMain.textContent = mbti;

      typeImg.src = profile.img;
      typeImg.alt = mbti;
      typeImg.onerror = () => { typeImg.style.display = "none"; };

      hashtagsEl.innerHTML = profile.hashtags.map(t => `<span class="tag">${t}</span>`).join("");
      bulletsEl.innerHTML = profile.bullets.map(t => `<li>${t}</li>`).join("");

      // ê·¸ë˜í”„
      if (score) {
        const bars = [
          { key: 'EI', left: 'E', right: 'I', label: 'ì—ë„ˆì§€' },
          { key: 'NS', left: 'N', right: 'S', label: 'ì¸ì‹' },
          { key: 'TF', left: 'T', right: 'F', label: 'íŒë‹¨' },
          { key: 'JP', left: 'J', right: 'P', label: 'ìƒí™œ' },
        ];

        mbtiBarsEl.innerHTML = bars.map(b => {
          const L = score[b.key][b.left];
          const R = score[b.key][b.right];
          return `
            <div class="barRow">
              <div class="barTop">
                <span class="barLabel">${b.label}</span>
                <span class="barPct">${b.left} ${L}% Â· ${b.right} ${R}%</span>
              </div>
              <div class="barTrack" role="img" aria-label="${b.left} ${L}%, ${b.right} ${R}%">
                <div class="barFill" style="width:${L}%;"></div>
              </div>
              <div class="barEnds">
                <span>${b.left}</span>
                <span>${b.right}</span>
              </div>
            </div>
          `;
        }).join('');
      } else {
        mbtiBarsEl.innerHTML = `<div class="muted">ê·¸ë˜í”„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.</div>`;
      }

      // GA
      track('view_result', { mbti: mbti || 'na' });

      // CTA
      const variant = getVariant();
      const ctaLabel = variant === 'B'
        ? "ì´ ì„±í–¥ì— ë§ëŠ” ë°ì´íŠ¸ ì½”ìŠ¤ ì¶”ì²œ ë°›ê¸°"
        : "HeartPinìœ¼ë¡œ ë°ì´íŠ¸ ì½”ìŠ¤ ì¶”ì²œ ë°›ê¸°";

      document.getElementById('ctaArea').innerHTML = `
        <button class="btn btn-primary" id="ctaBtn">${ctaLabel}</button>
        <button class="btn btn-secondary" id="retryBtn" type="button">í…ŒìŠ¤íŠ¸ ë‹¤ì‹œí•˜ê¸°</button>
      `;
      document.getElementById('variantHint').textContent = `variant=${variant}`;

      document.getElementById('retryBtn').addEventListener('click', () => {
        track('click_retry', { from: 'result', mbti: mbti || 'na', variant });
        location.href = 'index.html';
      });

      document.getElementById('ctaBtn').addEventListener('click', () => {
        const dest = new URL("https://naver.com");
        dest.searchParams.set("mbti", mbti || "na");
        dest.searchParams.set("v", variant);

        dest.searchParams.set("utm_source", "dating_mbti");
        dest.searchParams.set("utm_medium", "cta");
        dest.searchParams.set("utm_campaign", "ab_test");

        gtag('event', 'click_heartpin', {
          mbti: mbti || 'na',
          variant,
          destination: dest.toString(),
          event_callback: () => { location.href = dest.toString(); },
          event_timeout: 1200
        });
        setTimeout(() => { location.href = dest.toString(); }, 1300);
      });

      // ë¶„ì„ ì—°ì¶œ íƒ€ì´ë°
      const SPIN_MS = 1800;
      const CHECK_MS = 700;

      setTimeout(() => {
        spinner.style.display = 'none';
        check.style.display = 'flex';
        aTitle.textContent = 'ë¶„ì„ ì™„ë£Œ!';
        aSub.textContent = 'ê²°ê³¼ë¥¼ í™•ì¸í•´ë´ìš”';

        setTimeout(() => {
          overlay.style.display = 'none';
          resultCard.style.display = 'block';
        }, CHECK_MS);
      }, SPIN_MS);
    }
  </script>
</body>
</html>
